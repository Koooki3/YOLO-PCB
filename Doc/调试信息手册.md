# VisualRobot 调试信息手册

## 1. 概述

本手册详细说明了VisualRobot项目中调试信息的使用方法和规范。系统使用 `AppendLog` 函数记录不同级别的调试信息，帮助开发人员和用户追踪程序运行状态。

### 函数签名

```cpp
void AppendLog(const QString &message, int logType, double value = 0.0);
```

- **message**: 日志消息内容
- **logType**: 日志级别（INFO=0, WARNNING=1, ERROR=2）
- **value**: 可选的数值参数，当不为0.0时会自动添加到消息后面。该参数广泛用于显示误差值、性能指标（如处理时间、帧率）、测量结果等。例如：
  - 在坐标转换验证中，用于显示总误差：`AppendLog(..., INFO, total_error);`
  - 在性能监控中，用于显示清晰度或处理延时：`AppendLog(..., INFO, sharpness);`
  - 在测量结果中，用于显示长度、角度等：`AppendLog(..., INFO, length);`

更多value参数示例：
- 显示处理延时：`AppendLog(QString("图像处理延时: %1 ms").arg(value), INFO, processingTime);`
- 显示误差值：`AppendLog("坐标转换误差", INFO, errorValue);`
- 性能指标：`AppendLog("帧率: FPS", INFO, fps);`

## 2. 调试信息等级

系统定义了三个调试信息等级：

```cpp
#define ERROR 2      // 错误级别：用于严重错误，导致程序无法继续执行的情况
#define WARNNING 1   // 警告级别：用于可恢复的异常或潜在问题
#define INFO 0       // 信息级别：用于正常操作状态和成功信息
```

使用场景：
- **INFO**：记录成功操作、状态变化、数值结果。
- **WARNNING**：提示用户注意，如缺少资源或次优路径。
- **ERROR**：报告失败事件，通常伴随弹窗提示。

## 3. 核心功能模块调试信息

### 3.1 设备操作模块

- 设备枚举（位于 mainwindow.cpp 中的 on_bnEnum_clicked() 函数）

```cpp
AppendLog(QString("枚举到 %1 个MvCamera设备").arg(m_stDevList.nDeviceNum), INFO);
// 位于 on_bnEnum_clicked() 函数中
AppendLog("未知设备被枚举", WARNNING);
AppendLog("没有设备", WARNNING);
```

- 设备打开/关闭（位于 MvCamera.cpp 中的 openCamera() 和 closeCamera() 函数）

```cpp
AppendLog("设备打开成功", INFO);
AppendLog("设备关闭成功", INFO);
AppendLog("相机对象无效", ERROR);
```

### 3.2 图像采集模块

- 采集控制（位于 mainwindow.cpp 中的采集按钮槽函数）

```cpp
AppendLog("开始抓图成功", INFO);
AppendLog("停止抓图成功", INFO);
AppendLog("开始抓图失败", ERROR);
AppendLog("停止抓图失败", ERROR);
```

- 触发模式（位于参数设置相关函数）

```cpp
AppendLog("连续模式已开启", INFO);
AppendLog("触发模式已开启", INFO);
AppendLog("软件触发已开启", INFO);
AppendLog("软件触发已关闭", INFO);
```

### 3.3 参数设置模块

- 曝光参数（位于 configmanager.cpp 中的 setExposure() 函数）

```cpp
AppendLog(QString("获取曝光时间成功: %1").arg(value), INFO);
AppendLog(QString("设置曝光时间成功: %1").arg(value), INFO);
AppendLog("获取曝光时间失败", ERROR);
AppendLog("设置曝光时间失败", ERROR);
```

- 增益参数

```cpp
AppendLog(QString("获取增益成功: %1").arg(value), INFO);
AppendLog(QString("设置增益成功: %1").arg(value), INFO);
AppendLog("获取增益失败", ERROR);
AppendLog("设置增益失败", ERROR);
```

- 帧率参数

```cpp
AppendLog(QString("获取帧率成功: %1").arg(value), INFO);
AppendLog(QString("设置帧率成功: %1").arg(value), INFO);
AppendLog("获取帧率失败", ERROR);
AppendLog("设置帧率失败", ERROR);
```

### 3.4 图像处理模块

- 图像保存（位于 DIP.cpp 中的 saveImage() 函数）

```cpp
AppendLog(QString("保存成功，地址为：%1").arg(path), INFO);
AppendLog("暂无可用图像，请先开始采集", WARNNING);
AppendLog("内存不足（编码缓冲）", ERROR);
```

- 角点检测（位于 featureDetect.cpp 中的 detectCorners() 函数）

```cpp
AppendLog("待检测图像读取成功，角点检测算法执行完毕", INFO);
AppendLog("角点检测算法执行失败，请调整曝光或者重选待测物体", ERROR);
AppendLog("未能正确检测到角点", ERROR);
AppendLog(QString("第%1个角点(x,y)像素坐标为：(%2, %3)").arg(i+1).arg(x).arg(y), INFO);
```

### 3.5 坐标变换模块

- 矩阵操作（位于 Undistort.cpp 中的 loadMatrix() 和 transformCoords() 函数）

```cpp
AppendLog("成功读取变换矩阵，详见终端显示", INFO);
AppendLog("坐标矩阵变换成功", INFO);
AppendLog("变换矩阵计算并保存成功", INFO);
AppendLog(matrixStr, INFO);  // 显示变换矩阵内容
```

- 坐标转换验证（更新为实际代码格式，位于坐标验证函数中）

```cpp
AppendLog(QString("点 %1: 理论世界坐标(%2, %3) -> 变换后世界坐标(%4, %5)").arg(i)
          .arg(WorldCoord[i].X, 0, 'f', 3)
          .arg(WorldCoord[i].Y, 0, 'f', 3)
          .arg(transformedX, 0, 'f', 3)
          .arg(transformedY, 0, 'f', 3), INFO, totalError);
```

- 测量结果（修正单位为μm和pixels，位于测量函数中）

```cpp
AppendLog(QString("物件对角线（μm）：%1").arg(value), INFO);
AppendLog(QString("物件长度（μm）：%1").arg(value), INFO);
AppendLog(QString("物件宽度（pixels）：%1").arg(value), INFO);
AppendLog(QString("物件倾角（°）：%1").arg(value), INFO);
```

### 3.6 检长算法模块

- 标准检测模式（位于 DataProcessor.cpp 中的 measureLength() 函数）

```cpp
AppendLog("检测后图像显示成功", INFO);
AppendLog("检长算法执行完成", INFO);
AppendLog(QString("物件长度（μm）：%1").arg(length), INFO);
AppendLog(QString("物件宽度（μm）：%1").arg(width), INFO);
AppendLog(QString("物件倾角（°）：%1").arg(angle), INFO);
```

- 裁剪区域检测模式

```cpp
AppendLog("检测到多边形区域，将处理裁剪后的图像", INFO);
AppendLog("裁剪区域检测后图像显示成功", INFO);
AppendLog("裁剪区域检长算法执行完成", INFO);
AppendLog(QString("裁剪区域物件长度（μm）：%1").arg(length), INFO);
AppendLog(QString("裁剪区域物件宽度（μm）：%1").arg(width), INFO);
AppendLog(QString("裁剪区域物件倾角（°）：%1").arg(angle), INFO);
```

## 4. 高级功能模块调试信息

### 4.1 YOLO实时检测模块（位于 YOLOProcessorORT.cpp 中的相关函数）

```cpp
// 模型加载相关
AppendLog("YOLO模型加载失败", ERROR);
AppendLog("YOLO标签文件加载失败", ERROR);
AppendLog("YOLO模型和标签加载成功", INFO);

// 实时检测控制
AppendLog("YOLO实时检测已启动", INFO);
AppendLog("YOLO实时检测已在运行", INFO);
AppendLog("YOLO实时检测已停止", INFO);
AppendLog("相机未开始采集图像，无法启动YOLO实时检测", WARNNING);

// 统计信息
AppendLog(QString("YOLO实时检测统计- 帧率: %1 FPS, 总平均处理延时: %2 ms").arg(fps).arg(avgProcessingTime), INFO);
AppendLog(QString("  预处理: %1 ms, 推理: %2 ms, 后处理: %3 ms").arg(preprocessTime).arg(inferenceTime).arg(postprocessTime), INFO);
```

### 4.2 缺陷检测模块（位于 DefectDetection.cpp 中的相关函数）

```cpp
// 模板设置
AppendLog("模板已更新（来自当前帧）", INFO);
AppendLog("模板已更新（来自文件）", INFO);
AppendLog("尚未设置模板，请先设置模板。", WARNNING);

// 特征对齐
AppendLog(QString("特征对齐成功，耗时: %1 ms").arg(alignmentTime), INFO);
AppendLog("特征对齐失败，使用传统方法", WARNNING);
AppendLog("图像重构成功，已对齐到模板坐标系", INFO);
AppendLog("图像重构失败，使用原始图像", WARNNING);

// 实时缺陷检测
AppendLog("实时缺陷检测已启动", INFO);
AppendLog("实时检测已在运行", INFO);
AppendLog(QString("实时检测 - 缺陷数量稳定为: %1 个，已持续 2 秒以上").arg(count), INFO);
```

### 4.3 系统监控模块（位于 SystemMonitor.cpp 中的 monitorSharpness() 和 monitorResources() 函数）

```cpp
// 清晰度监控
AppendLog(QString("当前图像清晰度: %1").arg(sharpness, 0, 'f', 2), INFO);

// 系统资源监控
AppendLog(QString("CPU使用率: %1%, 内存使用率: %2%").arg(cpuUsage).arg(memoryUsage), INFO);
AppendLog("系统资源监控已启动", INFO);
```

### 4.4 多边形绘制模块（位于 mainwindow.cpp 中的绘制相关槽函数）

```cpp
AppendLog("多边形绘制功能已初始化", INFO);
AppendLog(QString("已添加第%1个点，坐标(%2, %3)").arg(pointCount).arg(x).arg(y), INFO);
AppendLog(QString("需要至少3个点才能绘制多边形，当前只有%1个点").arg(pointCount), WARNNING);
AppendLog(QString("开始绘制多边形，共%1个点").arg(pointCount), INFO);
AppendLog("多边形绘制完成，顶点坐标：", INFO);
AppendLog(QString("顶点%1: (%2, %3)").arg(i+1).arg(x).arg(y), INFO);
AppendLog(QString("多边形区域图像裁剪完成，尺寸: %1x%2 像素").arg(width).arg(height), INFO);
AppendLog(QString("背景颜色: RGB(%1, %2, %3)").arg(red).arg(green).arg(blue), INFO);
AppendLog("裁剪后的图像已显示", INFO);
AppendLog("已清除多边形显示", INFO);
AppendLog("请在widgetDisplay_2上显示图片后再进行点击", WARNNING);
AppendLog("多边形区域超出图像范围", WARNNING);
AppendLog("需要至少3个点才能裁剪图像", WARNNING);
```

- 图像显示状态

```cpp
AppendLog("检测后图像显示成功", INFO);
AppendLog("原始图像显示成功", INFO);
AppendLog("裁剪区域检测后图像显示成功", INFO);
```

## 5. 特殊功能调试信息

### 5.1 设备热拔插自动枚举（位于 mainwindow.cpp 中的定时器事件或枚举函数）

```cpp
AppendLog(QString("设备数量变化: %1 -> %2，自动更新设备列表").arg(oldCount).arg(newCount), INFO);
```

### 5.2 日志优化机制（位于 AppendLog 函数或日志管理中）

```cpp
// 稳定状态检测（减少重复日志）
// 当缺陷数量稳定2秒以上时，只记录一次日志
// 避免在稳定状态下频繁记录相同信息
AppendLog("日志优化：稳定状态检测启用，减少重复输出", INFO);
```

### 5.3 文档操作相关（位于 mainwindow.cpp 中的文档打开函数）

```cpp
AppendLog("已尝试打开调试信息手册", INFO);
```

## 6. 使用建议和最佳实践

1. 对于重要的操作步骤，应该使用INFO级别记录成功信息。
2. 当出现可恢复的异常情况时，使用WARNNING级别提示用户。
3. 对于导致程序无法继续执行的错误，使用ERROR级别通知用户。
4. 涉及具体数值的信息，建议使用QString的arg()函数格式化输出，并结合value参数显示额外指标。
5. 在开发新功能时，建议多添加调试信息，便于问题定位。优先在关键函数入口/出口添加日志。
6. 使用value参数记录性能数据，如延时、误差，帮助优化算法。
7. 避免日志洪水：对于稳定状态，使用优化机制减少重复日志。

## 7. 注意事项

1. 所有调试信息都会显示在主界面的日志区域。
2. 不同级别的信息使用不同颜色区分，便于快速识别（ERROR红色，WARNNING橙色，INFO黑色）。
3. 每条信息都会自动添加时间戳（格式：yyyy-MM-dd hh:mm:ss）。
4. 当日志较多时，会自动滚动到最新信息。
5. 错误级别的信息通常还会通过QMessageBox弹窗提示用户。
6. 日志文件保存在log/目录下，按日期命名。

## 调试信息分类统计

以下表格统计了手册中各类调试信息的数量和典型使用频率（基于代码实现估算）：

| 分类 | INFO | WARNNING | ERROR | 总计 | 使用频率 |
|------|------|----------|-------|------|----------|
| 设备操作 | 4 | 2 | 1 | 7 | 高（枚举/打开频繁） |
| 图像采集 | 4 | 0 | 2 | 6 | 中 |
| 参数设置 | 6 | 0 | 4 | 10 | 中 |
| 图像处理 | 3 | 1 | 3 | 7 | 高 |
| 坐标变换 | 4 | 0 | 0 | 4 | 中 |
| 检长算法 | 6 | 0 | 0 | 6 | 高 |
| YOLO检测 | 5 | 1 | 2 | 8 | 中 |
| 缺陷检测 | 5 | 2 | 0 | 7 | 中 |
| 系统监控 | 3 | 0 | 0 | 3 | 低 |
| 多边形绘制 | 8 | 3 | 0 | 11 | 低 |
| 特殊功能 | 3 | 0 | 0 | 3 | 低 |
| **总计** | **51** | **9** | **12** | **72** | -
